(function(){var rsplit=function(s,r){var a=[],res=r.exec(s),f,l,fbit;while(res!=null){f=res.index;l=r.lastIndex;if(f!=0){fbit=s.substring(0,f);a.push(s.substring(0,f));s=s.slice(f)}a.push(res[0]);s=s.slice(res[0].length);res=r.exec(s)}if(s!=''){a.push(s)}return a},chop=function(s){return s.substr(0,s.length-1)},extend=function(d,s){for(var n in s)if(s.hasOwnProperty(n))d[n]=s[n]};EJS=function(o){o=typeof o=="string"?{view:o}:o;this.set_options(o);if(o.precompiled){this.template={};this.template.process=o.precompiled;EJS.update(this.name,this);return}if(o.element){if(typeof o.element=='string'){var n=o.element;o.element=document.getElementById(o.element);if(o.element==null)throw n+'does not exist!'}this.text=o.element.value?o.element.value:o.element.innerHTML;this.name=o.element.id;this.type='['}else if(o.url){o.url=EJS.endExt(o.url,this.extMatch);this.name=this.name?this.name:o.url;var t=EJS.get(this.name,this.cache);if(t)return t;if(t==EJS.INVALID_PATH)return null;try{this.text=EJS.request(o.url+(this.cache?'':'?'+Math.random()))}catch(e){}if(this.text==null)throw{type:'EJS',message:'There is no template at '+o.url}}var template=new EJS.Compiler(this.text,this.type);template.compile(o,this.name);EJS.update(this.name,this);this.template=template};EJS.prototype={render:function(o,h){o=o||{};this._extra_helpers=h;var v=new EJS.Helpers(o,h||{});return this.template.process.call(o,o,v)},update:function(e,o){if(typeof e=='string')e=document.getElementById(e);if(o==null){var _t=this;return function(obj){EJS.prototype.update.call(_t,e,obj)}}if(typeof o=='string'){var p={};p.url=o;_t=this;p.onComplete=function(r){var obj=eval(r.responseText);EJS.prototype.update.call(_t,e,obj)};EJS.ajax_request(p)}else e.innerHTML=this.render(o)},out:function(){return this.template.out},set_options:function(o){this.type=o.type||EJS.type;this.cache=o.cache!=null?o.cache:EJS.cache;this.text=o.text||null;this.name=o.name||null;this.ext=o.ext||EJS.ext;this.extMatch=new RegExp(this.ext.replace(/\./,'\\.'))}};EJS.endExt=function(p,m){if(!p)return null;m.lastIndex=0;return p+(m.test(p)?'':this.ext)};EJS.Scanner=function(s,l,r){extend(this,{left_delimiter:l+'%',right_delimiter:'%'+r,double_left:l+'%%',double_right:'%%'+r,left_equal:l+'%=',left_comment:l+'%#'});this.SplitRegexp=l=='['?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp('('+this.double_left+')|(%%'+this.double_right+')|('+this.left_equal+')|('+this.left_comment+')|('+this.left_delimiter+')|('+this.right_delimiter+'\n)|('+this.right_delimiter+')|(\n)');this.source=s;this.stag=null;this.lines=0};EJS.Scanner.to_text=function(i){if(i==null||i===undefined)return'';if(i instanceof Date)return i.toDateString();if(i.toString)return i.toString();return''};EJS.Scanner.prototype={scan:function(b){var sl=this.scanline,rg=this.SplitRegexp;if(!this.source==''){var ss=rsplit(this.source,/\n/);for(var i=0;i<ss.length;i++){var it=ss[i];this.scanline(it,rg,b)}}},scanline:function(l,rg,b){this.lines++;var ls=rsplit(l,rg);for(var i=0;i<ls.length;i++){var t=ls[i];if(t!=null)try{b(t,this)}catch(e){throw{type:'EJS.Scanner',line:this.lines}}}}};EJS.Buffer=function(p,c){this.line=[];this.script='';this.pre_cmd=p;this.post_cmd=c;for(var i=0;i<this.pre_cmd.length;i++)this.push(p[i])};EJS.Buffer.prototype={push:function(c){this.line.push(c)},cr:function(){this.script+=this.line.join('; ');this.line=[];this.script+='\n'},close:function(){if(this.line.length>0){for(var i=0;i<this.post_cmd.length;i++)this.push(pre_cmd[i]);this.script+=this.line.join('; ');line=null}}};EJS.Compiler=function(s,l){this.pre_cmd=['var ___ViewO = [];'];this.post_cmd=[];this.source=' ';if(s!=null){if(typeof s=='string'){s=s.replace(/\r\n/g,"\n");s=s.replace(/\r/g,"\n");this.source=s}else if(s.innerHTML)this.source=s.innerHTML;if(typeof this.source!='string')this.source=''}l=l||'<';var r='>';switch(l){case'[':r=']';break;case'<':break;default:throw l+' is not a supported deliminator';break}this.scanner=new EJS.Scanner(this.source,l,r);this.out=''};EJS.Compiler.prototype={compile:function(o,n){o=o||{};this.out='';var pc="___ViewO.push(",ic=pc,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),c='',cln=function(c){c=c.replace(/\\/g,'\\\\');c=c.replace(/\n/g,'\\n');c=c.replace(/"/g,'\\"');return c};this.scanner.scan(function(t,s){if(s.stag==null){switch(t){case'\n':c+="\n";buff.push(pc+'"'+cln(c)+'");');buff.cr();c='';break;case s.left_delimiter:case s.left_equal:case s.left_comment:s.stag=t;if(c.length>0)buff.push(pc+'"'+cln(c)+'")');c='';break;case s.double_left:c+=s.left_delimiter;break;default:c+=t;break}}else{switch(t){case s.right_delimiter:switch(s.stag){case s.left_delimiter:if(c[c.length-1]=='\n'){c=chop(c);buff.push(c);buff.cr()}else buff.push(c);break;case s.left_equal:buff.push(ic+"(EJS.Scanner.to_text("+c+")))");break}s.stag=null;c='';break;case s.double_right:c+=s.right_delimiter;break;default:c+=t;break}}});if(c.length>0)buff.push(pc+'"'+cln(c)+'")');buff.close();this.out=buff.script+";";var tbe='/*'+n+'*/this.process=function(_CONTEXT,_VIEW){try{with(_VIEW){with(_CONTEXT){'+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(tbe)}catch(e){if(typeof JSLINT!='undefined'){JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var er=JSLINT.errors[i];if(er.reason!="Unnecessary semicolon."){er.line++;var e=new Error();e.lineNumber=er.line;e.message=er.reason;if(o.view)e.fileName=o.view;throw e}}}else throw e}}};EJS.config=function(o){EJS.cache=o.cache!=null?o.cache:EJS.cache;EJS.type=o.type!=null?o.type:EJS.type;EJS.ext=o.ext!=null?o.ext:EJS.ext;var tdir=EJS.templates_directory||{};EJS.templates_directory=tdir;EJS.get=function(p,c){if(c==false)return null;if(tdir[p])return tdir[p];return null};EJS.update=function(p,t){if(p==null)return;tdir[p]=t};EJS.INVALID_PATH=-1};EJS.config({cache:true,type:'<',ext:'.ejs'});EJS.Helpers=function(d,e){this._data=d;this._extras=e;extend(this,e)};EJS.Helpers.prototype={view:function(o,d,h){if(!h)h=this._extras;if(!d)d=this._data;return new EJS(o).render(d,h)},to_text:function(i,n){if(i==null||i===undefined)return n||'';if(i instanceof Date)return i.toDateString();if(i.toString)return i.toString().replace(/\n/g,'<br />').replace(/''/g,"'");return''}};EJS.newRequest=function(){var f=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var i=0;i<f.length;i++){try{var r=f[i]();if(r!=null)return r}catch(e){continue}}};EJS.request=function(p){var r=new EJS.newRequest();r.open("GET",p,false);try{r.send(null)}catch(e){return null}if(r.status==404||r.status==2||(r.status==0&&r.responseText==''))return null;return r.responseText};EJS.ajax_request=function(p){p.method=p.method?p.method:'GET';var r=new EJS.newRequest();r.onreadystatechange=function(){if(r.readyState==4){p.onComplete(r)}};r.open(p.method,p.url);r.send(null)}})();
